import streamlit as st
from openai import OpenAI
import json

# ======================================================
# Streamlit åŸºæœ¬è¨­å®š
# ======================================================
st.set_page_config(page_title="ä¸€èˆ¬è³ªå• æ¡ç‚¹AIã‚·ã‚¹ãƒ†ãƒ ï¼ˆ150ç‚¹ãƒ¢ãƒ‡ãƒ«ï¼‰", layout="wide")

# ======================================================
# API ã‚­ãƒ¼å…¥åŠ›
# ======================================================
st.sidebar.header("ğŸ”‘ OpenAI API Key")
api_key = st.sidebar.text_input("APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆsk-proj- ã‹ã‚‰å§‹ã¾ã‚‹ã‚­ãƒ¼ï¼‰", type="password")

client = None
if api_key:
    client = OpenAI(api_key=api_key)


# ======================================================
# 15é …ç›® Ã— 10æ®µéšã®è©•ä¾¡åŸºæº–
# ======================================================
criteria = {
    "1. ãƒ†ãƒ¼ãƒè¨­å®šã®å¦¥å½“æ€§": [
        "è­°ä¼šã§æ‰±ã†é‡è¦èª²é¡Œã«é«˜åº¦ã«é©åˆã—ã€æ ¹æ‹ è³‡æ–™ã‚‚ååˆ†ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã—ã¦å¦¥å½“æ€§ãŒé«˜ãã€è³‡æ–™ã‚‚è±Šå¯Œã€‚",
        "å¦¥å½“ãªãƒ†ãƒ¼ãƒã§èƒŒæ™¯ãŒæ˜ç­ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã¯é–¢é€£ã‚ã‚‹ãŒã€æ ¹æ‹ ãŒå¼±ã„ã€‚",
        "èª²é¡Œæ€§ã¯ã‚ã‚‹ãŒä¸€èˆ¬è«–ã«å¯„ã£ã¦ã„ã‚‹ã€‚",
        "å¦¥å½“æ€§ãŒä¸ååˆ†ã§èƒŒæ™¯ãŒæ›–æ˜§ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã—ã¦ã®ç·Šæ€¥æ€§ã‚„é‡è¦æ€§ãŒä½ã„ã€‚",
        "ä¸»è¦³çš„ã§æ ¹æ‹ ä¸è¶³ã€‚",
        "èª²é¡Œã¨ç„¡é–¢ä¿‚ã€ç„¦ç‚¹ãŒãšã‚Œã¦ã„ã‚‹ã€‚",
        "è­°ä¼šè³ªå•ã¨ã—ã¦ä¸é©åˆ‡ã€‚"
    ],
    "2. ç›®çš„ã®æ˜ç¢ºæ€§": [
        "ç›®çš„ãŒéå¸¸ã«æ˜ç¢ºã§è¡Œæ”¿è¡Œå‹•ãŒç‰¹å®šã•ã‚Œã¦ã„ã‚‹ã€‚",
        "ç›®çš„ãŒæ˜ç¢ºã§å¿…è¦ååˆ†ã€‚",
        "ç›®çš„ãŒæ¦‚ã­æ˜ç¢ºã€‚",
        "æ–¹å‘æ€§ã¯ç¤ºã•ã‚Œã¦ã„ã‚‹ãŒæŠ½è±¡çš„ã€‚",
        "èª¬æ˜ãŒä¸ååˆ†ã€‚",
        "è¡Œæ”¿ãŒä½•ã‚’å•ã‚ã‚Œã¦ã„ã‚‹ã‹åˆ†ã‹ã‚Šã«ãã„ã€‚",
        "æŠ½è±¡çš„ã§ç„¦ç‚¹ãŒã¼ã‚„ã‘ã¦ã„ã‚‹ã€‚",
        "ç›®çš„ãŒæ›–æ˜§ã€‚",
        "ç›®çš„ãŒã»ã¼ç¤ºã•ã‚Œã¦ã„ãªã„ã€‚",
        "ç›®çš„ãŒç†è§£ä¸èƒ½ã€‚"
    ],
    "3. è«–ç†æ§‹æˆã®æ˜ç¢ºæ€§": [
        "å°å…¥â†’èª²é¡Œâ†’åŸå› â†’æ ¹æ‹ â†’ææ¡ˆãŒå®Œç’§ã§é£›èºãªã—ã€‚",
        "è«–ç†æ§‹æˆãŒéå¸¸ã«æ˜å¿«ã€‚",
        "è«–ç†ã®æµã‚ŒãŒæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "ã‚„ã‚„é£›èºãŒã‚ã‚‹ãŒç†è§£å¯èƒ½ã€‚",
        "è«–æ—¨ãŒéƒ¨åˆ†çš„ã«ä¸æ˜ç­ã€‚",
        "è©±ã®æµã‚Œã«ä¸€è²«æ€§ãŒå¼±ã„ã€‚",
        "é£›èºãŒå¤šãç†è§£ã—ã¥ã‚‰ã„ã€‚",
        "è«–æ‹ ã®æç¤ºãŒã»ã¼æ¬ ã‘ã‚‹ã€‚",
        "æ§‹é€ ã¨ã—ã¦æˆç«‹ã—ã¦ã„ãªã„ã€‚",
        "è«–ç†æ€§ãŒã‚¼ãƒ­ã€‚"
    ],
    "4. æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã®å¦¥å½“æ€§": [
        "çµ±è¨ˆãƒ»è³‡æ–™ãƒ»ä¼šè­°éŒ²ãƒ»å…ˆè¡Œäº‹ä¾‹ãŒè±Šå¯Œã§é©åˆ‡ã€ä¿¡é ¼æ€§æŠœç¾¤ã€‚",
        "æ ¹æ‹ ãŒå¤šãå¦¥å½“ã€‚",
        "å¿…è¦ãªæ ¹æ‹ ãŒæƒã£ã¦ã„ã‚‹ã€‚",
        "å¼•ç”¨ãŒå°‘ãªã„ãŒæœ€ä½é™ã¯ã‚ã‚‹ã€‚",
        "æ ¹æ‹ ã«å¼±ã•ãŒã‚ã‚‹ã€‚",
        "æ ¹æ‹ ä¸è¶³ã§èª¬å¾—åŠ›ãŒå¼±ã„ã€‚",
        "ä¸»è¦³çš„ãªè¨˜è¿°ãŒå¤šã„ã€‚",
        "è¨¼æ‹ ã®å¤§éƒ¨åˆ†ãŒä¸æ˜ç¢ºã€‚",
        "æ ¹æ‹ ãŒã»ã¨ã‚“ã©æ¬ ã‘ã¦ã„ã‚‹ã€‚",
        "æ€ã„è¾¼ã¿ã®ã¿ã§æ ¹æ‹ ã‚¼ãƒ­ã€‚"
    ],
    "5. è³ªå•ã®å…·ä½“æ€§": [
        "è¡Œæ”¿ãŒè¡Œå‹•å¯èƒ½ãªãƒ¬ãƒ™ãƒ«ï¼ˆèª°ãŒãƒ»ã„ã¤ãƒ»ä½•ã‚’ï¼‰ã«å…·ä½“åŒ–ã€‚",
        "è¡Œæ”¿ãŒå³ç­”ã—ã‚„ã™ã„å…·ä½“æ€§ã€‚",
        "ååˆ†ã«å…·ä½“çš„ã€‚",
        "æ–¹å‘æ€§ã¯æ˜ç¢ºã ãŒæŠ½è±¡çš„ã€‚",
        "æŠ½è±¡ãŒå¤šã„ãŒå‡¦ç†å¯èƒ½ã€‚",
        "æŠ½è±¡çš„ã§è¡Œæ”¿ãŒåˆ¤æ–­ã—ã¥ã‚‰ã„ã€‚",
        "ä¸€èˆ¬è«–ãŒå¤šã„ã€‚",
        "å…·ä½“æ€§ãŒä¹ã—ã„ã€‚",
        "æ¦‚å¿µã®ã¿ã§æ›–æ˜§ã€‚",
        "å®Œå…¨ã«æŠ½è±¡çš„ã€‚"
    ],
    "6. æ”¿ç­–ææ¡ˆã®å®Ÿç¾å¯èƒ½æ€§": [
        "è²¡æ”¿ãƒ»æ³•ä»¤ãƒ»ä½“åˆ¶ã«åŸºã¥ãæ¥µã‚ã¦ç¾å®Ÿçš„ãªææ¡ˆã€‚",
        "å®Ÿç¾å¯èƒ½æ€§ãŒé«˜ã„ã€‚",
        "ã‚„ã‚„ä¿®æ­£ã™ã‚Œã°å®Ÿç¾å¯èƒ½ã€‚",
        "è‰¯ã„æ–¹å‘ã ãŒå…·ä½“æ€§ä¸è¶³ã€‚",
        "éšœå£ãŒæ˜ç¢ºã«å­˜åœ¨ã™ã‚‹ã€‚",
        "éç¾å®Ÿçš„è¦ç´ ãŒå¤šã„ã€‚",
        "è¡Œæ”¿èƒ½åŠ›ã‚’ç„¡è¦–ã—ã¦ã„ã‚‹ã€‚",
        "å®Ÿç¾å›°é›£ã€‚",
        "è¡Œæ”¿ã®å®Ÿå‹™ã‚’ç†è§£ã—ã¦ã„ãªã„ã€‚",
        "å®Ÿç¾ä¸å¯èƒ½ãªè¦æ±‚ã€‚"
    ],
    "7. è¡Œæ”¿ç­”å¼ã‚’å¼•ãå‡ºã™è³ªå•åŠ›": [
        "ä¸€èˆ¬è«–ã§ã¯é€ƒã’ã‚‰ã‚Œãšå…·ä½“å›ç­”ã‚’å¾—ã‚‰ã‚Œã‚‹è¨­å•è¨­è¨ˆã€‚",
        "ç­”å¼ã‚’å¼•ãå‡ºã™å·¥å¤«ãŒååˆ†ã€‚",
        "ç­”ãˆã‚„ã™ã„è³ªå•æ§‹é€ ã€‚",
        "æ‚ªããªã„ãŒæ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "æŠ½è±¡çš„ã§ç­”å¼ã®å¹…ãŒåºƒã„ã€‚",
        "ä¸€èˆ¬è«–ã«é€ƒã’ã‚‰ã‚Œã‚„ã™ã„ã€‚",
        "è¶£æ—¨ãŒæ›–æ˜§ã§ç­”å¼ãŒã‚ºãƒ¬ã‚‹å¯èƒ½æ€§ã€‚",
        "ç­”å¼å›°é›£ãªè³ªå•ã€‚",
        "æ§‹é€ ãŒãªãä¸¸æŠ•ã’ã€‚",
        "ç­”å¼ä¸èƒ½ãªä¸é©åˆ‡ãªè³ªå•ã€‚"
    ],
    "8. è­°ä¼šã®å½¹å‰²ãƒ»æ³•çš„ç†è§£": [
        "è­°ä¼šã®ç›£è¦–ãƒ»æ”¿ç­–å½¢æˆæ©Ÿèƒ½ã‚’é«˜åº¦ã«ç†è§£ã—æ³•çš„æ ¹æ‹ ã‚‚é©åˆ‡ã€‚",
        "è­°ä¼šã®å½¹å‰²ã‚’ååˆ†ç†è§£ã—ã¦ã„ã‚‹ã€‚",
        "æ¦‚ã­å•é¡Œãªã—ã€‚",
        "éƒ¨åˆ†çš„ã«æ›–æ˜§ã€‚",
        "æ¨©é™ç†è§£ãŒå¼±ã„ã€‚",
        "è¡Œæ”¿ã¨ã®å½¹å‰²æ··åŒãŒã‚ã‚‹ã€‚",
        "è­°ä¼šã®é™ç•Œã‚’ç†è§£ã—ã¦ã„ãªã„ã€‚",
        "æ”¿æ²»å€«ç†ã«æŠµè§¦ã—å¾—ã‚‹è¡¨ç¾ã€‚",
        "è­°ä¼šæ¨©é™å¤–ã®è¦æ±‚ã€‚",
        "è­°ä¼šã¨ã—ã¦ä¸é©åˆ‡ã€‚"
    ],
    "9. ä½æ°‘è¦–ç‚¹ãƒ»èª¬æ˜è²¬ä»»": [
        "ä½æ°‘åˆ©ç›ŠãŒæ˜ç¢ºã§èª¬æ˜è²¬ä»»ã‚‚ååˆ†ã€éå¸¸ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚",
        "ä½æ°‘ç›®ç·šãŒååˆ†ã€‚",
        "åˆ†ã‹ã‚Šã‚„ã™ãæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "ä½æ°‘ãƒ¡ãƒªãƒƒãƒˆãŒå¼±ã„ã€‚",
        "å°‚é–€çš„ã™ãã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã€‚",
        "ä½æ°‘è¦–ç‚¹ãŒä¸è¶³ã€‚",
        "è¡Œæ”¿å†…éƒ¨å‘ã‘è³ªå•ã«åã‚‹ã€‚",
        "å¸‚æ°‘ã«ç†è§£ã•ã‚Œã«ãã„ã€‚",
        "ä½æ°‘åˆ©ç›ŠãŒã»ã¼ç¤ºã•ã‚Œã¦ã„ãªã„ã€‚",
        "å¸‚æ°‘ã®åˆ©ç›Šã¨ç„¡é–¢ä¿‚ã€‚"
    ],
    "10. ç­”å¼å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼å¯èƒ½æ€§": [
        "KPIåŒ–ã•ã‚Œæ”¹å–„çŠ¶æ³ã‚’æ¤œè¨¼å¯èƒ½ãªè¨­è¨ˆã€‚",
        "ãƒ•ã‚©ãƒ­ãƒ¼ã—ã‚„ã™ã„ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ãˆã‚‹ã€‚",
        "ä¸€å®šã®ãƒ•ã‚©ãƒ­ãƒ¼ã¯å¯èƒ½ã€‚",
        "å·¥å¤«ã™ã‚Œã°ãƒ•ã‚©ãƒ­ãƒ¼å¯èƒ½ã€‚",
        "æ”¹å–„çŠ¶æ³ãŒè¿½ã„ã¥ã‚‰ã„ã€‚",
        "ç¶™ç¶šå¯©æŸ»ã«ä¸å‘ãã€‚",
        "æ›–æ˜§ãªç­”å¼ã§çµ‚ã‚ã‚‹å¯èƒ½æ€§é«˜ã„ã€‚",
        "æ”¿ç­–æ¤œè¨¼ãŒã§ããªã„ã€‚",
        "ãƒ•ã‚©ãƒ­ãƒ¼ä¸èƒ½ã€‚"
    ],
    "11. æ–‡ç« è¡¨ç¾ãƒ»ã‚¹ãƒ”ãƒ¼ãƒæŠ€è¡“": [
        "éå¸¸ã«æ˜å¿«ãƒ»ç°¡æ½”ãƒ»ä¸å¯§ã§è² è·ãŒãªã„ã€‚",
        "æ´—ç·´ã•ã‚ŒãŸè¡¨ç¾ã€‚",
        "ååˆ†ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚",
        "æ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "å†—é•·ãƒ»ä¸æ˜ç­ãªè¡¨ç¾ãŒã‚ã‚‹ã€‚",
        "ä¼ã‚ã‚Šã«ãã„éƒ¨åˆ†ãŒå¤šã„ã€‚",
        "èª¤è§£ã‚’æ‹›ãè¡¨ç¾ãŒã‚ã‚‹ã€‚",
        "æ–‡ç« æ§‹é€ ãŒç ´ç¶»ã—ã¦ã„ã‚‹ã€‚",
        "ä¸é©åˆ‡ãªè¨€è‘‰é£ã„ã€‚",
        "è¡¨ç¾ã¨ã—ã¦æˆç«‹ã—ã¦ã„ãªã„ã€‚"
    ],
    "12. è¡Œæ”¿ã¨ã®å”åƒå§¿å‹¢ãƒ»å€«ç†æ€§": [
        "å…¬å¹³ãƒ»ä¸­ç«‹ãƒ»ä½æ°‘åˆ©ç›Šå„ªå…ˆã§å€«ç†ã‚‚å®Œç’§ã€‚",
        "é©åˆ‡ãªå§¿å‹¢ã€‚",
        "æ¦‚ã­è‰¯å¥½ã€‚",
        "æ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "è¡Œæ”¿åœ§è¿«ã¨å—ã‘å–ã‚‰ã‚Œã‹ã­ãªã„ã€‚",
        "å…¬å¹³æ€§ã«ç–‘ç¾©ã‚ã‚Šã€‚",
        "åˆ©ç›Šèª˜å°ã¨èª¤è§£ã•ã‚Œã‚‹æã‚Œã€‚",
        "è¡Œæ”¿è² æ‹…ã‚’éåº¦ã«å¢—ã‚„ã™ã€‚",
        "å€«ç†ã«åã™ã‚‹æã‚Œã€‚",
        "æ”¿æ²»å€«ç†é•åãƒ¬ãƒ™ãƒ«ã€‚"
    ],
    "13. å°†æ¥å¿—å‘ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ€§": [
        "DX/AIãƒ»æŒç¶šå¯èƒ½æ€§ç­‰ã‚’è¸ã¾ãˆãŸé«˜åº¦ãªæœªæ¥ææ¡ˆã€‚",
        "å°†æ¥è¦–ç‚¹ãŒå¼·ã„ã€‚",
        "æ–°ã—ã„ç™ºæƒ³ãŒã‚ã‚‹ã€‚",
        "ä¸€å®šã®å°†æ¥å¿—å‘ã€‚",
        "ç¾çŠ¶ç¶­æŒå‹ã€‚",
        "æœªæ¥è¦–ç‚¹ãŒå¼±ã„ã€‚",
        "çŸ­æœŸçš„è¦–é‡ã€‚",
        "é©æ–°æ€§ãŒã»ã¼ãªã„ã€‚",
        "å¾Œã‚å‘ãã€‚",
        "æ™‚ä»£ã«é€†è¡Œã—ã¦ã„ã‚‹ã€‚"
    ],
    "14. æ”¿ç­–æ¨ªæ–­æ€§ãƒ»å…¨ä½“è¦–ç‚¹": [
        "è¤‡æ•°æ–½ç­–ã‚’æ¨ªæ–­ã—é«˜åº¦ã«çµ±åˆã—ãŸåˆ†æã€‚",
        "éƒ¨å±€æ¨ªæ–­è¦–ç‚¹ãŒå¼·ã„ã€‚",
        "åºƒã„è¦–é‡ã§æ•´ç†ã€‚",
        "æ¦‚ã­OKã€‚",
        "ã‚„ã‚„è¦–é‡ãŒé™å®šçš„ã€‚",
        "å˜ä¸€éƒ¨å±€ã«åã‚‹ã€‚",
        "æ¨ªæ–­çš„ç†è§£ãŒä¸è¶³ã€‚",
        "è¦–é‡ç‹­çª„ã€‚",
        "å…¨ä½“åƒãŒãªã„ã€‚",
        "æ–­ç‰‡çš„ã§ç„¡ç§©åºã€‚"
    ],
    "15. è­°å“¡ã¨ã—ã¦ã®æˆé•·ãƒ»ç¶™ç¶šæ€§": [
        "éå»è³ªå•ã®æ”¹å–„ãŒé¡•è‘—ã§æ·±ã¾ã‚ŠãŒã‚ã‚‹ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒãŒä¸€è²«ã€‚",
        "æ”¹å–„æ„è­˜ãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚",
        "ä¸€å®šã®ç¶™ç¶šæ€§ã‚ã‚Šã€‚",
        "å¤‰åŒ–ãŒå¼±ã„ã€‚",
        "æ¯å›ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å°è±¡ã€‚",
        "æ”¹å–„ãŒè¦‹ãˆãªã„ã€‚",
        "èª²é¡ŒãŒå›ºå®šåŒ–ã—ã¦ã„ã‚‹ã€‚",
        "æˆé•·ãŒä¹ã—ã„ã€‚",
        "æ”¹å–„ãªã—ã€‚"
    ]
}


# ======================================================
# ãƒ©ãƒ³ã‚¯åˆ¤å®š
# ======================================================
def judge_rank(total):
    if total >= 135:
        return "Sï¼ˆéå¸¸ã«å„ªã‚ŒãŸä¸€èˆ¬è³ªå•ï¼‰"
    if total >= 120:
        return "Aï¼ˆæ”¿ç­–åŠ¹æœãŒæœŸå¾…ã§ãã‚‹é«˜å“è³ªï¼‰"
    if total >= 105:
        return "Bï¼ˆä¸€å®šæ°´æº–ãƒ»æ”¹å–„ä½™åœ°ã‚ã‚Šï¼‰"
    if total >= 90:
        return "Cï¼ˆè¦æ”¹å–„ï¼‰"
    if total >= 75:
        return "Dï¼ˆè³ªãŒä½ã„ï¼‰"
    return "Eï¼ˆå†æ§‹ç¯‰ãŒå¿…è¦ï¼‰"


# ======================================================
# GPT ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
# ======================================================
def build_eval_prompt(text):
    prompt = f"""
ã‚ãªãŸã¯ã€Œè­°ä¼šè³ªå•ã®å°‚é–€è©•ä¾¡è€…ã€ã§ã™ã€‚
ä»¥ä¸‹ã®ä¸€èˆ¬è³ªå•ã®æ–‡ç« ã‚’ã€15é …ç›® Ã— 1ã€œ10ç‚¹ã§æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚

ã€è©•ä¾¡å¯¾è±¡ã®æ–‡ç« ã€‘
{text}

ã€å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰ã€‘
JSON ã®ã¿ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚

{{
"score": {{
   "1": 1ã€œ10,
   "2": 1ã€œ10,
   ...
   "15": 1ã€œ10
}},
"total": åˆè¨ˆç‚¹,
"rank": "S/A/B/C/D/E",
"reason": {{
    "1": "ç†ç”±",
    ...
    "15": "ç†ç”±"
}}
}}

â€»å¿…ãš JSON ã®ã¿è¿”ã—ã¦ãã ã•ã„ã€‚
"""
    return prompt


# ======================================================
# UIï¼šã‚¿ãƒ–
# ======================================================
tab_ai, tab_manual = st.tabs(["ğŸ¤– AIè‡ªå‹•æ¡ç‚¹", "ğŸ“ æ‰‹å‹•æ¡ç‚¹"])


# ======================================================
# AIæ¡ç‚¹ã‚¿ãƒ–
# ======================================================
with tab_ai:

    st.header("ğŸ¤– AI è‡ªå‹•æ¡ç‚¹ï¼ˆGPT-4.1ï¼‰")

    text = st.text_area("ä¸€èˆ¬è³ªå•ã®æ–‡ç« ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„", height=300)

    if st.button("ğŸš€ AIã§æ¡ç‚¹ã™ã‚‹"):
        if not api_key:
            st.error("APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        elif not text.strip():
            st.error("æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        else:
            with st.spinner("AIãŒæ¡ç‚¹ã—ã¦ã„ã¾ã™â€¦"):

                prompt = build_eval_prompt(text)

                response = client.chat.completions.create(
                    model="gpt-4.1",
                    messages=[{"role": "user", "content": prompt}]
                )

                raw = response.choices[0].message.content

                try:
                    data = json.loads(raw)
                except:
                    st.error("AIã®è¿”ç­”ãŒJSONå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“")
                    st.code(raw)
                    st.stop()

                st.success("æ¡ç‚¹å®Œäº†ï¼")

                # ç‚¹æ•°ä¸€è¦§
                st.subheader("ğŸ“Š å„é …ç›®ã®ç‚¹æ•°")
                for i in range(1, 16):
                    st.write(f"### {i}. ç‚¹æ•°ï¼š{data['score'][str(i)]}/10")
                    st.write(f"ç†ç”±ï¼š{data['reason'][str(i)]}")
                    st.markdown("---")

                st.markdown(f"## ğŸ”¢ åˆè¨ˆç‚¹ï¼š**{data['total']} / 150**")
                st.markdown(f"## ğŸ† ãƒ©ãƒ³ã‚¯ï¼š**{judge_rank(data['total'])}**")


# ======================================================
# æ‰‹å‹•æ¡ç‚¹ã‚¿ãƒ–
# ======================================================
with tab_manual:

    st.header("ğŸ“ 150ç‚¹ãƒ¢ãƒ‡ãƒ«ã®æ‰‹å‹•æ¡ç‚¹")

    total_manual = 0

    for title, items in criteria.items():
        with st.expander(title):
            score = st.slider("ç‚¹æ•°ã‚’é¸æŠ", 1, 10, 5)
            st.write(f"æ¡ç‚¹ç†ç”±ã®ä¾‹ï¼š{items[10 - score]}")
            total_manual += score

    st.markdown("---")
    st.subheader(f"ğŸ”¢ åˆè¨ˆç‚¹ï¼š**{total_manual} / 150**")
    st.subheader(f"ğŸ† ãƒ©ãƒ³ã‚¯ï¼š**{judge_rank(total_manual)}**")
