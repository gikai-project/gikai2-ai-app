import streamlit as st
from openai import OpenAI
import json
import plotly.graph_objects as go

# ======================================================
# Streamlit åŸºæœ¬è¨­å®š
# ======================================================
st.set_page_config(
    page_title="ä¸€èˆ¬è³ªå• æ¡ç‚¹AIã‚·ã‚¹ãƒ†ãƒ ï¼ˆ150ç‚¹ãƒ¢ãƒ‡ãƒ« å®Œå…¨ç‰ˆï¼‰",
    layout="wide"
)

# ======================================================
# API ã‚­ãƒ¼å…¥åŠ›ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼‰
# ======================================================
st.sidebar.header("ğŸ”‘ OpenAI API Key")
api_key = st.sidebar.text_input(
    "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆsk-proj- ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ï¼‰",
    type="password"
)

client = None
if api_key:
    client = OpenAI(api_key=api_key)

# ======================================================
# 15é …ç›® Ã— 10æ®µéš è©•ä¾¡åŸºæº–ï¼ˆindex0=10ç‚¹, index9=1ç‚¹ï¼‰
# ======================================================
criteria = {
    "1. ãƒ†ãƒ¼ãƒè¨­å®šã®å¦¥å½“æ€§": [
        "é‡è¦ãªåœ°åŸŸèª²é¡Œã«é«˜åº¦ã«é©åˆã—ã€æ ¹æ‹ è³‡æ–™ã‚‚ååˆ†ã€‚å¸¸ã«è­°ä¼šã§æ‰±ã†ã¹ãè«–ç‚¹ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã—ã¦å¦¥å½“æ€§ãŒé«˜ãã€è³‡æ–™ã‚‚è±Šå¯Œã€‚",
        "å¦¥å½“ãªãƒ†ãƒ¼ãƒã§ã€èƒŒæ™¯ãŒæ˜ç­ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã®é–¢é€£ã¯ã‚ã‚‹ãŒã€ã‚„ã‚„æ ¹æ‹ ãŒå¼±ã„ã€‚",
        "èª²é¡Œæ€§ã¯ã‚ã‚‹ãŒä¸€èˆ¬è«–ã«å¯„ã£ã¦ã„ã‚‹ã€‚",
        "å¦¥å½“æ€§ãŒä¸ååˆ†ã§ã€èƒŒæ™¯ãŒæ›–æ˜§ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã—ã¦ã®ç·Šæ€¥æ€§ã‚„é‡è¦æ€§ãŒä½ã„ã€‚",
        "ä¸»è¦³çš„ãªãƒ†ãƒ¼ãƒè¨­å®šã§ã€æ ¹æ‹ ä¸è¶³ã€‚",
        "èª²é¡Œã¨ç„¡é–¢ä¿‚ã€ç„¦ç‚¹ãŒãšã‚Œã¦ã„ã‚‹ã€‚",
        "è­°ä¼šè³ªå•ã¨ã—ã¦ä¸é©åˆ‡ã€‚"
    ],
    "2. ç›®çš„ã®æ˜ç¢ºæ€§": [
        "ç›®çš„ãŒéå¸¸ã«æ˜ç¢ºã§ã€è¡Œæ”¿ãŒå–ã‚‹ã¹ãè¡Œå‹•ãŒç‰¹å®šã•ã‚Œã¦ã„ã‚‹ã€‚",
        "æ˜ç¢ºã§ã€å¿…è¦ååˆ†ãªèª¬æ˜ãŒã‚ã‚‹ã€‚",
        "ç›®çš„ãŒæ¦‚ã­æ˜ç¢ºã€‚",
        "æ–¹å‘æ€§ã¯ç¤ºã•ã‚Œã¦ã„ã‚‹ãŒã€ã‚„ã‚„æŠ½è±¡çš„ã€‚",
        "ç›®çš„ã®èª¬æ˜ãŒä¸ååˆ†ã€‚",
        "è¡Œæ”¿ãŒä½•ã‚’å•ã‚ã‚Œã¦ã„ã‚‹ã‹åˆ†ã‹ã‚Šã«ãã„ã€‚",
        "æŠ½è±¡çš„ã§ç„¦ç‚¹ãŒã¼ã‚„ã‘ã¦ã„ã‚‹ã€‚",
        "ç›®çš„ãŒæ›–æ˜§ã€‚",
        "ç›®çš„ãŒã»ã¼ç¤ºã•ã‚Œã¦ã„ãªã„ã€‚",
        "è³ªå•ã®ç›®çš„ãŒç†è§£ä¸èƒ½ã€‚"
    ],
    "3. è«–ç†æ§‹æˆã®æ˜ç¢ºæ€§": [
        "å°å…¥â†’èª²é¡Œâ†’åŸå› â†’æ ¹æ‹ â†’ææ¡ˆã®æµã‚ŒãŒå®Œç’§ã§ã€è«–ç†é£›èºãªã—ã€‚",
        "è«–ç†æ§‹æˆãŒéå¸¸ã«æ˜å¿«ã€‚",
        "è«–ç†ã®æµã‚ŒãŒæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "ã‚„ã‚„é£›èºãŒã‚ã‚‹ãŒæ¦‚ã­ç†è§£å¯èƒ½ã€‚",
        "è«–æ—¨ãŒéƒ¨åˆ†çš„ã«ä¸æ˜ç­ã€‚",
        "è©±ã®æµã‚Œã«ä¸€è²«æ€§ãŒå¼±ã„ã€‚",
        "é£›èºãŒå¤šãç†è§£ã—ã¥ã‚‰ã„ã€‚",
        "è«–æ‹ ã®æç¤ºãŒã»ã¼æ¬ ã‘ã‚‹ã€‚",
        "æ§‹é€ ã¨ã—ã¦æˆç«‹ã—ã¦ã„ãªã„ã€‚",
        "è«–ç†æ€§ãŒã»ã¼ã‚¼ãƒ­ã€‚"
    ],
    "4. æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã®å¦¥å½“æ€§": [
        "çµ±è¨ˆãƒ»è³‡æ–™ãƒ»ä¼šè­°éŒ²ãƒ»å…ˆè¡Œäº‹ä¾‹ãŒè±Šå¯Œã§é©åˆ‡ã€‚ä¿¡é ¼æ€§ã‚‚é«˜ã„ã€‚",
        "æ ¹æ‹ ãŒå¤šãå¦¥å½“ã€‚",
        "å¿…è¦ãªæ ¹æ‹ ãŒæƒã£ã¦ã„ã‚‹ã€‚",
        "å¼•ç”¨ãŒå°‘ãªã„ãŒæœ€ä½é™ã¯ã‚ã‚‹ã€‚",
        "æ ¹æ‹ ã«ã‚„ã‚„å¼±ã•ãŒã‚ã‚‹ã€‚",
        "æ ¹æ‹ ãŒä¸è¶³ã—èª¬å¾—åŠ›ãŒå¼±ã„ã€‚",
        "ä¸»è¦³çš„ãªè¨˜è¿°ãŒå¤šã„ã€‚",
        "è¨¼æ‹ ã®å¤§éƒ¨åˆ†ãŒä¸æ˜ç¢ºã€‚",
        "ã»ã¨ã‚“ã©æ ¹æ‹ ãŒæ¬ ã‘ã¦ã„ã‚‹ã€‚",
        "æ ¹æ‹ ã‚¼ãƒ­ã€‚æ€ã„è¾¼ã¿ã®ã¿ã€‚"
    ],
    "5. è³ªå•ã®å…·ä½“æ€§": [
        "è¡Œæ”¿ãŒè¡Œå‹•å¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã«å…·ä½“åŒ–ï¼ˆèª°ãŒãƒ»ã„ã¤ãƒ»ä½•ã‚’ï¼‰ã€‚",
        "è¡Œæ”¿ãŒå³ç­”ã—ã‚„ã™ã„å…·ä½“æ€§ã€‚",
        "ååˆ†ã«å…·ä½“çš„ã€‚",
        "æ–¹å‘æ€§ã¯æ˜ç¢ºã€ã‚„ã‚„æŠ½è±¡ã€‚",
        "å‡¦ç†å¯èƒ½ã ãŒæŠ½è±¡å¤šã‚ã€‚",
        "æŠ½è±¡çš„ã§è¡Œæ”¿ãŒåˆ¤æ–­ã—ã¥ã‚‰ã„ã€‚",
        "ä¸€èˆ¬è«–ãŒå¤šã„ã€‚",
        "ã»ã¨ã‚“ã©å…·ä½“æ€§ãªã—ã€‚",
        "å¤§ã¾ã‹ãªæ¦‚å¿µã®ã¿ã€‚",
        "å®Œå…¨ã«æŠ½è±¡çš„ã€‚"
    ],
    "6. æ”¿ç­–ææ¡ˆã®å®Ÿç¾å¯èƒ½æ€§": [
        "è²¡æ”¿ãƒ»æ³•ä»¤ãƒ»ä½“åˆ¶ã‚’è¸ã¾ãˆãŸæ¥µã‚ã¦ç¾å®Ÿçš„ãªææ¡ˆã€‚",
        "å®Ÿç¾å¯èƒ½æ€§ãŒé«˜ã„ã€‚",
        "ã‚„ã‚„ä¿®æ­£ã™ã‚Œã°å®Ÿç¾å¯èƒ½ã€‚",
        "æ–¹å‘æ€§ã¯è‰¯ã„ãŒå…·ä½“æ€§ä¸è¶³ã€‚",
        "å®Ÿç¾ã®éšœå£ãŒæ˜ç¢ºã€‚",
        "éç¾å®Ÿçš„è¦ç´ ãŒå¤šã„ã€‚",
        "è¡Œæ”¿èƒ½åŠ›ã‚’ç„¡è¦–ã—ãŸææ¡ˆã€‚",
        "å®Ÿç¾å›°é›£ã€‚",
        "è¡Œæ”¿ã®ä»•äº‹ã‚’ç†è§£ã—ã¦ã„ãªã„ã€‚",
        "å®Ÿç¾ä¸å¯èƒ½ãªè¦æ±‚ã€‚"
    ],
    "7. è¡Œæ”¿ç­”å¼ã‚’å¼•ãå‡ºã™è³ªå•åŠ›": [
        "ä¸€èˆ¬è«–ã§é€ƒã’ã‚‰ã‚Œãšå…·ä½“å›ç­”ã‚’å¾—ã‚‰ã‚Œã‚‹é«˜åº¦ãªè¨­å•è¨­è¨ˆã€‚",
        "ç­”å¼ã‚’å¼•ãå‡ºã™å·¥å¤«ãŒååˆ†ã€‚",
        "ç­”ãˆã‚„ã™ã„è³ªå•æ§‹é€ ã€‚",
        "æ‚ªããªã„ãŒæ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "æŠ½è±¡çš„ã§ç­”å¼ã®å¹…ãŒåºƒã„ã€‚",
        "ä¸€èˆ¬è«–ã«é€ƒã’ã‚‰ã‚Œã‚„ã™ã„ã€‚",
        "è¶£æ—¨ãŒæ›–æ˜§ã§ç­”å¼ãŒã‚ºãƒ¬ã‚‹å¯èƒ½æ€§ã€‚",
        "ç­”å¼å›°é›£ãªè³ªå•ã€‚",
        "æ§‹é€ ãŒãªãä¸¸æŠ•ã’ã€‚",
        "ç­”å¼ä¸èƒ½ãƒ»ä¸é©åˆ‡ãªè³ªå•ã€‚"
    ],
    "8. è­°ä¼šã®å½¹å‰²ãƒ»æ³•çš„ç†è§£": [
        "è­°ä¼šã®ç›£è¦–æ©Ÿèƒ½ãƒ»æ”¿ç­–å½¢æˆæ©Ÿèƒ½ã‚’é«˜åº¦ã«ç†è§£ã€‚æ³•çš„æ ¹æ‹ ã‚‚é©åˆ‡ã€‚",
        "è­°ä¼šã®å½¹å‰²ã‚’ååˆ†è¸ã¾ãˆã¦ã„ã‚‹ã€‚",
        "æ¦‚ã­å•é¡Œãªã—ã€‚",
        "éƒ¨åˆ†çš„ã«æ›–æ˜§ã€‚",
        "è­°ä¼šã®æ¨©é™ç†è§£ãŒå¼±ã„ã€‚",
        "è¡Œæ”¿ã¨ã®å½¹å‰²æ··åŒãŒã‚ã‚‹ã€‚",
        "è­°ä¼šã®é™ç•Œã‚’ç†è§£ã—ã¦ã„ãªã„ã€‚",
        "æ”¿æ²»å€«ç†ã«æŠµè§¦ã—ã†ã‚‹è¡¨ç¾ã‚ã‚Šã€‚",
        "è­°ä¼šæ¨©é™å¤–ã®è¦æ±‚ã€‚",
        "è­°ä¼šã¨ã—ã¦ä¸é©åˆ‡ã€‚"
    ],
    "9. ä½æ°‘è¦–ç‚¹ãƒ»èª¬æ˜è²¬ä»»ã®æ˜ç­æ€§": [
        "ä½æ°‘åˆ©ç›ŠãŒæ˜ç¢ºã§ã€èª¬æ˜è²¬ä»»ã‚‚ååˆ†ã€‚éå¸¸ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚",
        "ä½æ°‘ç›®ç·šãŒååˆ†ã€‚",
        "åˆ†ã‹ã‚Šã‚„ã™ãæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "ä½æ°‘ãƒ¡ãƒªãƒƒãƒˆãŒå¼±ã„ã€‚",
        "å°‚é–€çš„ã™ãã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã€‚",
        "ä½æ°‘è¦–ç‚¹ãŒä¸è¶³ã—ã¦ã„ã‚‹ã€‚",
        "è¡Œæ”¿å†…éƒ¨å‘ã‘ã®è³ªå•ã«åã‚‹ã€‚",
        "å¸‚æ°‘ã«ç†è§£ã•ã‚Œã«ãã„ã€‚",
        "ä½æ°‘åˆ©ç›ŠãŒã»ã¼ç¤ºã•ã‚Œã¦ã„ãªã„ã€‚",
        "å¸‚æ°‘ã®åˆ©ç›Šã¨ç„¡é–¢ä¿‚ã€‚"
    ],
    "10. ç­”å¼å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼å¯èƒ½æ€§": [
        "KPIåŒ–ã•ã‚Œæ”¹å–„çŠ¶æ³ã‚’æ¤œè¨¼å¯èƒ½ã€‚",
        "ãƒ•ã‚©ãƒ­ãƒ¼ã—ã‚„ã™ã„ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ãˆã‚‹ã€‚",
        "ä¸€å®šã®ãƒ•ã‚©ãƒ­ãƒ¼ã¯å¯èƒ½ã€‚",
        "å·¥å¤«ã™ã‚Œã°ãƒ•ã‚©ãƒ­ãƒ¼å¯èƒ½ã€‚",
        "æ”¹å–„çŠ¶æ³ãŒè¿½ã„ã¥ã‚‰ã„ã€‚",
        "ç¶™ç¶šå¯©æŸ»ã«ä¸å‘ãã€‚",
        "æ›–æ˜§ãªç­”å¼ã§çµ‚ã‚ã‚‹å¯èƒ½æ€§é«˜ã„ã€‚",
        "æ”¿ç­–æ¤œè¨¼ãŒã§ããªã„ã€‚",
        "ãƒ•ã‚©ãƒ­ãƒ¼ä¸èƒ½ã€‚"
    ],
    "11. æ–‡ç« è¡¨ç¾ãƒ»ã‚¹ãƒ”ãƒ¼ãƒæŠ€è¡“": [
        "éå¸¸ã«æ˜å¿«ãƒ»ç°¡æ½”ãƒ»ä¸å¯§ã€èãæ‰‹ã«è² è·ãªã—ã€‚",
        "æ´—ç·´ã•ã‚ŒãŸè¡¨ç¾ã€‚",
        "ååˆ†ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚",
        "æ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "å†—é•·ãƒ»ä¸æ˜ç­ãªç®‡æ‰€ãŒã‚ã‚‹ã€‚",
        "ä¼ã‚ã‚Šã«ãã„éƒ¨åˆ†ãŒå¤šã„ã€‚",
        "èª¤è§£ã‚’æ‹›ãè¡¨ç¾ã‚ã‚Šã€‚",
        "æ–‡ç« æ§‹é€ ãŒç ´ç¶»ã—ã¦ã„ã‚‹ã€‚",
        "ä¸é©åˆ‡ãªè¨€è‘‰é£ã„ã€‚",
        "è¡¨ç¾ã¨ã—ã¦æˆç«‹ã—ã¦ã„ãªã„ã€‚"
    ],
    "12. è¡Œæ”¿ã¨ã®å”åƒå§¿å‹¢ãƒ»å€«ç†æ€§": [
        "å…¬å¹³ãƒ»ä¸­ç«‹ãƒ»ä½æ°‘åˆ©ç›Šå„ªå…ˆã§å€«ç†ã‚‚å®Œç’§ã€‚",
        "é©åˆ‡ãªå§¿å‹¢ã€‚",
        "æ¦‚ã­è‰¯å¥½ã€‚",
        "æ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "è¡Œæ”¿åœ§è¿«ã¨å—ã‘å–ã‚‰ã‚Œã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚",
        "å…¬å¹³æ€§ã«ç–‘ç¾©ã‚ã‚Šã€‚",
        "åˆ©ç›Šèª˜å°ã¨èª¤è§£ã•ã‚Œã‚‹æã‚Œã€‚",
        "è¡Œæ”¿è² æ‹…ã‚’éåº¦ã«å¢—ã‚„ã™ã€‚",
        "å€«ç†ã«åã™ã‚‹æã‚Œã€‚",
        "æ”¿æ²»å€«ç†é•åãƒ¬ãƒ™ãƒ«ã€‚"
    ],
    "13. å°†æ¥å¿—å‘ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ€§": [
        "DX/AIãƒ»æŒç¶šå¯èƒ½æ€§ç­‰ã‚’è¸ã¾ãˆãŸé«˜åº¦ãªæœªæ¥ææ¡ˆã€‚",
        "å°†æ¥è¦–ç‚¹ãŒå¼·ã„ã€‚",
        "æ–°ã—ã„ç™ºæƒ³ãŒã‚ã‚‹ã€‚",
        "ä¸€å®šã®å°†æ¥å¿—å‘ãŒã‚ã‚‹ã€‚",
        "ç¾çŠ¶ç¶­æŒå‹ã€‚",
        "æœªæ¥è¦–ç‚¹ãŒå¼±ã„ã€‚",
        "çŸ­æœŸçš„è¦–é‡ã«åã‚‹ã€‚",
        "é©æ–°æ€§ãŒã»ã¼ãªã„ã€‚",
        "å¾Œã‚å‘ããªææ¡ˆã€‚",
        "æ™‚ä»£ã«é€†è¡Œã—ã¦ã„ã‚‹ã€‚"
    ],
    "14. æ”¿ç­–æ¨ªæ–­æ€§ãƒ»å…¨ä½“è¦–ç‚¹": [
        "è¤‡æ•°æ–½ç­–ã‚’æ¨ªæ–­ã—ã€é«˜åº¦ã«çµ±åˆã—ãŸåˆ†æã€‚",
        "éƒ¨å±€æ¨ªæ–­ã®è¦–ç‚¹ãŒå¼·ã„ã€‚",
        "åºƒã„è¦–é‡ã§æ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "æ¦‚ã­OKã€‚",
        "è¦–é‡ãŒã‚„ã‚„é™å®šã•ã‚Œã¦ã„ã‚‹ã€‚",
        "å˜ä¸€éƒ¨å±€è¦–ç‚¹ã«åã‚‹ã€‚",
        "æ¨ªæ–­çš„ç†è§£ãŒä¸è¶³ã€‚",
        "è¦–é‡ç‹­çª„ã€‚",
        "å…¨ä½“åƒãŒãªã„ã€‚",
        "æ–­ç‰‡çš„ã§ç„¡ç§©åºã€‚"
    ],
    "15. è­°å“¡ã¨ã—ã¦ã®æˆé•·ãƒ»ç¶™ç¶šæ€§": [
        "éå»è³ªå•ã®æ”¹å–„ãŒé¡•è‘—ã§æ·±ã¾ã‚ŠãŒã‚ã‚‹ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒã®è¿½ç©¶ãŒä¸€è²«ã—ã¦ã„ã‚‹ã€‚",
        "æ”¹å–„æ„è­˜ãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒã¸ã®é–¢å¿ƒã‚ã‚Šã€‚",
        "å¤‰åŒ–ãŒã‚„ã‚„å¼±ã„ã€‚",
        "æ¯å›ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å°è±¡ã€‚",
        "æ”¹å–„ãŒè¦‹ãˆãªã„ã€‚",
        "èª²é¡ŒãŒå›ºå®šåŒ–ã—ã¦ã„ã‚‹ã€‚",
        "æˆé•·ãŒä¹ã—ã„ã€‚",
        "æ”¹å–„ãŒã¾ã£ãŸãè¦‹ã‚‰ã‚Œãªã„ã€‚"
    ]
}

# ======================================================
# å³ã—ã‚ãƒ©ãƒ³ã‚¯åˆ¤å®š
# ======================================================
def judge_rank(total):
    if total >= 135:
        return "Sï¼ˆéå¸¸ã«å„ªã‚ŒãŸä¸€èˆ¬è³ªå•ï¼‰"
    if total >= 120:
        return "Aï¼ˆè³ªãŒé«˜ãæ”¿ç­–åŠ¹æœãŒæœŸå¾…ã§ãã‚‹ï¼‰"
    if total >= 105:
        return "Bï¼ˆä¸€å®šæ°´æº–ã ãŒæ”¹å–„ä½™åœ°ã‚ã‚Šï¼‰"
    if total >= 90:
        return "Cï¼ˆåŸºæœ¬çš„æ°´æº–ã€è¦æ”¹å–„ï¼‰"
    if total >= 75:
        return "Dï¼ˆè³ªãŒä½ãã€åŠ¹æœãŒå¼±ã„ï¼‰"
    return "Eï¼ˆè­°ä¼šè³ªå•ã¨ã—ã¦å†æ§‹ç¯‰ãŒå¿…è¦ï¼‰"

# ======================================================
# ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæç”»
# ======================================================
def show_radar_chart(scores_dict, title="ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆè©•ä¾¡åˆ†å¸ƒï¼‰"):
    labels = [
        "ãƒ†ãƒ¼ãƒè¨­å®š", "ç›®çš„", "è«–ç†æ§‹æˆ", "æ ¹æ‹ ", "å…·ä½“æ€§",
        "å®Ÿç¾å¯èƒ½æ€§", "ç­”å¼èª˜å°", "è­°ä¼šç†è§£", "ä½æ°‘è¦–ç‚¹", "ãƒ•ã‚©ãƒ­ãƒ¼",
        "è¡¨ç¾æŠ€è¡“", "å€«ç†æ€§", "å°†æ¥å¿—å‘", "æ¨ªæ–­æ€§", "ç¶™ç¶šæ€§"
    ]
    values = [scores_dict[str(i)] for i in range(1, 16)]

    fig = go.Figure()
    fig.add_trace(go.Scatterpolar(
        r=values + [values[0]],
        theta=labels + [labels[0]],
        fill="toself",
        line=dict(width=3),
        name="score"
    ))

    fig.update_layout(
        polar=dict(radialaxis=dict(visible=True, range=[0, 10])),
        showlegend=False,
        title=title
    )

    st.plotly_chart(fig, use_container_width=True)

# ======================================================
# AI æ¡ç‚¹ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆå³ã—ã‚æ¡ç‚¹ï¼‰
# ======================================================
def build_eval_prompt(text):
    items_text = "\n".join([f"{i}. {k}" for i, k in enumerate(criteria.keys(), start=1)])

    prompt = f"""
ã‚ãªãŸã¯ã€Œåœ°æ–¹è­°ä¼šã®ä¸€èˆ¬è³ªå•ã€ã‚’å³æ ¼ã«è©•ä¾¡ã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚

ä»¥ä¸‹ã®ä¸€èˆ¬è³ªå•ã‚’ **å³ã—ã‚ã«æ¡ç‚¹** ã—ã¦ãã ã•ã„ã€‚
ç‰¹ã«ã€7ã€œ10ç‚¹ã¯ã€Œæ¥µã‚ã¦å„ªã‚ŒãŸå†…å®¹ã€ã«ã®ã¿ä»˜ä¸ã—ã€
æ›–æ˜§ãƒ»ä¸€èˆ¬è«–ãƒ»è«–ç†ä¸è¶³ãƒ»æ ¹æ‹ ä¸è¶³ãŒå°‘ã—ã§ã‚‚ã‚ã‚Œã° 1ã€œ3ç‚¹ã‚’ç©æ¥µçš„ã«ä»˜ä¸ã—ã¦ãã ã•ã„ã€‚

ã€è©•ä¾¡é …ç›®ã€‘
{items_text}

ã€æ¡ç‚¹åŸºæº–ï¼ˆé‡è¦ï¼‰ã€‘
- æ¡ç‚¹ã¯â€œç”˜ãã›ãšå³ã—ã‚â€ã«è¡Œã†
- é€šå¸¸ãƒ¬ãƒ™ãƒ«ã¯ 4ã€œ6 ç‚¹ã¨ã™ã‚‹
- æ›–æ˜§ãƒ»æ ¹æ‹ ä¸è¶³ãƒ»ä¸€èˆ¬è«–ã®å ´åˆã¯ 1ã€œ3 ç‚¹
- æ˜ç¢ºãªè«–ç†ã€æ ¹æ‹ ã€ææ¡ˆãŒæƒã£ã¦åˆã‚ã¦ 7 ç‚¹ä»¥ä¸Š
- 8ã€œ10 ç‚¹ã¯ã€Œéå¸¸ã«å„ªã‚ŒãŸä¾‹å¤–çš„ãªè³ªå•ã€ã®ã¿ã«ä»˜ä¸ã™ã‚‹

ã€è©•ä¾¡å¯¾è±¡ã®æ–‡ç« ã€‘
{text}

ã€å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰ã€‘
{{
  "scores": {{
    "1": 1ã€œ10 ã®æ•´æ•°,
    "2": 1ã€œ10 ã®æ•´æ•°,
    ...
    "15": 1ã€œ10 ã®æ•´æ•°
  }},
  "total": åˆè¨ˆç‚¹,
  "rank": "S" or "A" or "B" or "C" or "D" or "E",
  "reasons": {{
    "1": "ç†ç”±ï¼ˆå³ã—ã‚ã®è¦³ç‚¹ã‚‚è¨˜è¼‰ï¼‰",
    ...
    "15": "ç†ç”±"
  }}
}}

å¿…ãš JSON ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
"""

    return prompt.strip()

# ======================================================
# UIï¼šã‚¿ãƒ–
# ======================================================
tab_ai, tab_manual = st.tabs(["ğŸ¤– AIè‡ªå‹•æ¡ç‚¹", "ğŸ“ æ‰‹å‹•æ¡ç‚¹"])

# ======================================================
# ã‚¿ãƒ–1ï¼šAI è‡ªå‹•æ¡ç‚¹
# ======================================================
with tab_ai:
    st.header("ğŸ¤– AI è‡ªå‹•æ¡ç‚¹ï¼ˆGPT-4.1ï¼‰")

    question_text = st.text_area("ä¸€èˆ¬è³ªå•ã®åŸç¨¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„", height=280)

    if st.button("ğŸš€ AIã§è‡ªå‹•æ¡ç‚¹ã™ã‚‹"):
        if not api_key:
            st.error("APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        elif not question_text.strip():
            st.error("æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“")
        else:
            with st.spinner("AIãŒå³ã—ã‚ã«æ¡ç‚¹ã—ã¦ã„ã¾ã™â€¦"):

                # æ¡ç‚¹
                prompt = build_eval_prompt(question_text)
                response = client.chat.completions.create(
                    model="gpt-4.1",
                    messages=[{"role": "user", "content": prompt}]
                )

                raw = response.choices[0].message.content.strip()
                start = raw.find("{")
                end = raw.rfind("}")
                raw_json = raw[start:end+1]
                data = json.loads(raw_json)

                scores = {str(k): int(v) for k, v in data["scores"].items()}
                total = data["total"]
                rank = data["rank"]
                reasons = data["reasons"]

                st.success("æ¡ç‚¹å®Œäº†ï¼ˆå³ã—ã‚ï¼‰")

                st.subheader("ğŸ“Š å„é …ç›®ã®è©•ä¾¡")
                titles = list(criteria.keys())

                for i in range(1, 16):
                    with st.expander(f"{i}. {titles[i-1]}ï¼š{scores[str(i)]}ç‚¹"):
                        st.write(reasons[str(i)])

                st.markdown("---")
                st.subheader(f"ğŸ”¢ åˆè¨ˆç‚¹ï¼š**{total} / 150 ç‚¹**")
                st.subheader(f"ğŸ† ãƒ©ãƒ³ã‚¯ï¼š**{judge_rank(total)}**")

                # ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆ
                st.subheader("ğŸ“ˆ ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼ˆAIæ¡ç‚¹ï¼‰")
                show_radar_chart(scores)

                # æ”¹å–„ææ¡ˆ
                improve_prompt = f"""
ã‚ãªãŸã¯åœ°æ–¹è­°ä¼šä¸€èˆ¬è³ªå•ã®å°‚é–€æ·»å‰Šè€…ã§ã™ã€‚
æ¬¡ã®æ–‡ç« ã‚’ã€ŒSãƒ©ãƒ³ã‚¯ã€ã«è¿‘ã¥ã‘ã‚‹ãŸã‚ã€
æ”¹å–„ã™ã¹ãç‚¹ã‚’ **5ã¤ã ã‘** ç®‡æ¡æ›¸ãã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚
å„é …ç›®ã¯æœ€å¤§60æ–‡å­—ã§æ›¸ã„ã¦ãã ã•ã„ã€‚

ã€è³ªå•æ–‡ã€‘
{question_text}

ã€ç¾åœ¨ã®è©•ä¾¡ã€‘
{json.dumps(data, ensure_ascii=False, indent=2)}
"""

                improve_response = client.chat.completions.create(
                    model="gpt-4.1",
                    messages=[{"role": "user", "content": improve_prompt}]
                )

                st.subheader("ğŸ›  æ”¹å–„ææ¡ˆï¼ˆSãƒ©ãƒ³ã‚¯ã«ã™ã‚‹ã«ã¯ï¼Ÿï¼‰")
                st.write(improve_response.choices[0].message.content)

# ======================================================
# ã‚¿ãƒ–2ï¼šæ‰‹å‹•æ¡ç‚¹
# ======================================================
with tab_manual:
    st.header("ğŸ“ æ‰‹å‹•æ¡ç‚¹")

    total_manual = 0
    titles = list(criteria.keys())

    for idx, (title, desc_list) in enumerate(criteria.items(), start=1):
        with st.expander(f"{idx}.
