import streamlit as st
from openai import OpenAI
import json

# ======================================================
# Streamlit åŸºæœ¬è¨­å®š
# ======================================================
st.set_page_config(
    page_title="ä¸€èˆ¬è³ªå• æ¡ç‚¹AIã‚·ã‚¹ãƒ†ãƒ ï¼ˆ150ç‚¹ãƒ¢ãƒ‡ãƒ«ï¼‰",
    layout="wide"
)

# ======================================================
# ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šAPI ã‚­ãƒ¼å…¥åŠ›
# ======================================================
st.sidebar.header("ğŸ”‘ OpenAI API Key")
api_key = st.sidebar.text_input(
    "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆsk-proj- ã‹ã‚‰å§‹ã¾ã‚‹ã‚­ãƒ¼ï¼‰",
    type="password"
)

client = None
if api_key:
    client = OpenAI(api_key=api_key)

# ======================================================
# 15é …ç›® Ã— 10æ®µéš è©•ä¾¡åŸºæº–
# ï¼ˆindex0=10ç‚¹, index9=1ç‚¹ï¼‰
# ======================================================
criteria = {
    "1. ãƒ†ãƒ¼ãƒè¨­å®šã®å¦¥å½“æ€§": [
        "é‡è¦ãªåœ°åŸŸèª²é¡Œã«é«˜åº¦ã«é©åˆã—ã€æ ¹æ‹ è³‡æ–™ã‚‚ååˆ†ã€‚å¸¸ã«è­°ä¼šã§æ‰±ã†ã¹ãè«–ç‚¹ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã—ã¦å¦¥å½“æ€§ãŒé«˜ãã€è³‡æ–™ã‚‚è±Šå¯Œã€‚",
        "å¦¥å½“ãªãƒ†ãƒ¼ãƒã§ã€èƒŒæ™¯ãŒæ˜ç­ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã®é–¢é€£ã¯ã‚ã‚‹ãŒã€ã‚„ã‚„æ ¹æ‹ ãŒå¼±ã„ã€‚",
        "èª²é¡Œæ€§ã¯ã‚ã‚‹ãŒä¸€èˆ¬è«–ã«å¯„ã£ã¦ã„ã‚‹ã€‚",
        "å¦¥å½“æ€§ãŒä¸ååˆ†ã§ã€èƒŒæ™¯ãŒæ›–æ˜§ã€‚",
        "åœ°åŸŸèª²é¡Œã¨ã—ã¦ã®ç·Šæ€¥æ€§ã‚„é‡è¦æ€§ãŒä½ã„ã€‚",
        "ä¸»è¦³çš„ãªãƒ†ãƒ¼ãƒè¨­å®šã§ã€æ ¹æ‹ ä¸è¶³ã€‚",
        "èª²é¡Œã¨ç„¡é–¢ä¿‚ã€ç„¦ç‚¹ãŒãšã‚Œã¦ã„ã‚‹ã€‚",
        "è­°ä¼šè³ªå•ã¨ã—ã¦ä¸é©åˆ‡ã€‚"
    ],
    "2. ç›®çš„ã®æ˜ç¢ºæ€§": [
        "ç›®çš„ãŒéå¸¸ã«æ˜ç¢ºã§ã€è¡Œæ”¿ãŒå–ã‚‹ã¹ãè¡Œå‹•ãŒç‰¹å®šã•ã‚Œã¦ã„ã‚‹ã€‚",
        "æ˜ç¢ºã§ã€å¿…è¦ååˆ†ãªèª¬æ˜ãŒã‚ã‚‹ã€‚",
        "ç›®çš„ãŒæ¦‚ã­æ˜ç¢ºã€‚",
        "æ–¹å‘æ€§ã¯ç¤ºã•ã‚Œã¦ã„ã‚‹ãŒã€ã‚„ã‚„æŠ½è±¡çš„ã€‚",
        "ç›®çš„ã®èª¬æ˜ãŒä¸ååˆ†ã€‚",
        "è¡Œæ”¿ãŒä½•ã‚’å•ã‚ã‚Œã¦ã„ã‚‹ã‹åˆ†ã‹ã‚Šã«ãã„ã€‚",
        "æŠ½è±¡çš„ã§ç„¦ç‚¹ãŒã¼ã‚„ã‘ã¦ã„ã‚‹ã€‚",
        "ç›®çš„ãŒæ›–æ˜§ã€‚",
        "ç›®çš„ãŒã»ã¼ç¤ºã•ã‚Œã¦ã„ãªã„ã€‚",
        "è³ªå•ã®ç›®çš„ãŒç†è§£ä¸èƒ½ã€‚"
    ],
    "3. è«–ç†æ§‹æˆã®æ˜ç¢ºæ€§": [
        "å°å…¥â†’èª²é¡Œâ†’åŸå› â†’æ ¹æ‹ â†’ææ¡ˆã®æµã‚ŒãŒå®Œç’§ã§ã€è«–ç†é£›èºãªã—ã€‚",
        "è«–ç†æ§‹æˆãŒéå¸¸ã«æ˜å¿«ã€‚",
        "è«–ç†ã®æµã‚ŒãŒæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "ã‚„ã‚„é£›èºãŒã‚ã‚‹ãŒæ¦‚ã­ç†è§£å¯èƒ½ã€‚",
        "è«–æ—¨ãŒéƒ¨åˆ†çš„ã«ä¸æ˜ç­ã€‚",
        "è©±ã®æµã‚Œã«ä¸€è²«æ€§ãŒå¼±ã„ã€‚",
        "é£›èºãŒå¤šãç†è§£ã—ã¥ã‚‰ã„ã€‚",
        "è«–æ‹ ã®æç¤ºãŒã»ã¼æ¬ ã‘ã‚‹ã€‚",
        "æ§‹é€ ã¨ã—ã¦æˆç«‹ã—ã¦ã„ãªã„ã€‚",
        "è«–ç†æ€§ãŒã»ã¼ã‚¼ãƒ­ã€‚"
    ],
    "4. æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã®å¦¥å½“æ€§": [
        "çµ±è¨ˆãƒ»è³‡æ–™ãƒ»ä¼šè­°éŒ²ãƒ»å…ˆè¡Œäº‹ä¾‹ãŒè±Šå¯Œã§é©åˆ‡ã€‚ä¿¡é ¼æ€§ã‚‚é«˜ã„ã€‚",
        "æ ¹æ‹ ãŒå¤šãå¦¥å½“ã€‚",
        "å¿…è¦ãªæ ¹æ‹ ãŒæƒã£ã¦ã„ã‚‹ã€‚",
        "å¼•ç”¨ãŒå°‘ãªã„ãŒæœ€ä½é™ã¯ã‚ã‚‹ã€‚",
        "æ ¹æ‹ ã«ã‚„ã‚„å¼±ã•ãŒã‚ã‚‹ã€‚",
        "æ ¹æ‹ ãŒä¸è¶³ã—èª¬å¾—åŠ›ãŒå¼±ã„ã€‚",
        "ä¸»è¦³çš„ãªè¨˜è¿°ãŒå¤šã„ã€‚",
        "è¨¼æ‹ ã®å¤§éƒ¨åˆ†ãŒä¸æ˜ç¢ºã€‚",
        "ã»ã¨ã‚“ã©æ ¹æ‹ ãŒæ¬ ã‘ã¦ã„ã‚‹ã€‚",
        "æ ¹æ‹ ã‚¼ãƒ­ã€‚æ€ã„è¾¼ã¿ã®ã¿ã€‚"
    ],
    "5. è³ªå•ã®å…·ä½“æ€§": [
        "è¡Œæ”¿ãŒè¡Œå‹•å¯èƒ½ãªãƒ¬ãƒ™ãƒ«ã«å…·ä½“åŒ–ã•ã‚Œã¦ã„ã‚‹ï¼ˆèª°ãŒãƒ»ã„ã¤ãƒ»ä½•ã‚’ï¼‰ã€‚",
        "è¡Œæ”¿ãŒå³ç­”ã—ã‚„ã™ã„å…·ä½“æ€§ã€‚",
        "ååˆ†ã«å…·ä½“çš„ã€‚",
        "æ–¹å‘æ€§ã¯æ˜ç¢ºã€ã‚„ã‚„æŠ½è±¡ã€‚",
        "å‡¦ç†å¯èƒ½ã ãŒæŠ½è±¡å¤šã‚ã€‚",
        "æŠ½è±¡çš„ã§ã€è¡Œæ”¿ãŒåˆ¤æ–­ã—ã¥ã‚‰ã„ã€‚",
        "ä¸€èˆ¬è«–ãŒå¤šã„ã€‚",
        "ã»ã¨ã‚“ã©å…·ä½“æ€§ãªã—ã€‚",
        "å¤§ã¾ã‹ãªæ¦‚å¿µã®ã¿ã€‚",
        "å®Œå…¨ã«æŠ½è±¡çš„ã€‚"
    ],
    "6. æ”¿ç­–ææ¡ˆã®å®Ÿç¾å¯èƒ½æ€§": [
        "è²¡æ”¿ãƒ»æ³•ä»¤ãƒ»ä½“åˆ¶ã‚’è¸ã¾ãˆãŸæ¥µã‚ã¦ç¾å®Ÿçš„ãªææ¡ˆã€‚",
        "å®Ÿç¾å¯èƒ½æ€§ãŒé«˜ã„ã€‚",
        "ã‚„ã‚„ä¿®æ­£ã™ã‚Œã°å®Ÿç¾å¯èƒ½ã€‚",
        "æ–¹å‘æ€§ã¯è‰¯ã„ãŒå…·ä½“æ€§ä¸è¶³ã€‚",
        "å®Ÿç¾ã®éšœå£ãŒæ˜ç¢ºã€‚",
        "éç¾å®Ÿçš„è¦ç´ ãŒå¤šã„ã€‚",
        "è¡Œæ”¿èƒ½åŠ›ã‚’ç„¡è¦–ã—ãŸææ¡ˆã€‚",
        "å®Ÿç¾å›°é›£ã€‚",
        "è¡Œæ”¿ã®ä»•äº‹ã‚’ç†è§£ã—ã¦ã„ãªã„ã€‚",
        "å®Ÿç¾ä¸å¯èƒ½ãªè¦æ±‚ã€‚"
    ],
    "7. è¡Œæ”¿ç­”å¼ã‚’å¼•ãå‡ºã™è³ªå•åŠ›": [
        "ä¸€èˆ¬è«–ã§ã¯é€ƒã’ã‚‰ã‚Œãšã€å…·ä½“å›ç­”ã‚’å¾—ã‚‰ã‚Œã‚‹é«˜åº¦ãªè¨­å•è¨­è¨ˆã€‚",
        "ç­”å¼ã‚’å¼•ãå‡ºã™å·¥å¤«ãŒååˆ†ã€‚",
        "ç­”ãˆã‚„ã™ã„è³ªå•æ§‹é€ ã€‚",
        "æ‚ªããªã„ãŒæ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "ã‚„ã‚„æŠ½è±¡çš„ã§ç­”å¼ã®å¹…ãŒåºƒã„ã€‚",
        "ä¸€èˆ¬è«–ã«é€ƒã’ã‚‰ã‚Œã‚„ã™ã„ã€‚",
        "è¶£æ—¨ãŒæ›–æ˜§ã§ç­”å¼ãŒã‚ºãƒ¬ã‚‹å¯èƒ½æ€§ã€‚",
        "ç­”å¼å›°é›£ãªè³ªå•ã€‚",
        "æŠ•ã’ã£ã±ãªã—ã§å¿œç­”ã®æ§‹é€ ãŒãªã„ã€‚",
        "ç­”å¼ä¸èƒ½ãƒ»ä¸é©åˆ‡ã€‚"
    ],
    "8. è­°ä¼šã®å½¹å‰²ãƒ»æ³•çš„ç†è§£": [
        "è­°ä¼šã®ç›£è¦–æ©Ÿèƒ½ãƒ»æ”¿ç­–å½¢æˆæ©Ÿèƒ½ã‚’é«˜åº¦ã«ç†è§£ã€‚æ³•çš„æ ¹æ‹ ã‚‚é©åˆ‡ã€‚",
        "è­°ä¼šã®å½¹å‰²ã‚’ååˆ†è¸ã¾ãˆã¦ã„ã‚‹ã€‚",
        "æ¦‚ã­å•é¡Œãªã—ã€‚",
        "éƒ¨åˆ†çš„ã«æ›–æ˜§ã€‚",
        "è­°ä¼šã®æ¨©é™ç†è§£ãŒå¼±ã„ã€‚",
        "è¡Œæ”¿ã¨ã®å½¹å‰²æ··åŒãŒã‚ã‚‹ã€‚",
        "è­°ä¼šã®é™ç•Œã‚’ç†è§£ã—ã¦ã„ãªã„ã€‚",
        "æ”¿æ²»å€«ç†ã«æŠµè§¦ã—ã†ã‚‹è¡¨ç¾ã‚ã‚Šã€‚",
        "è­°ä¼šæ¨©é™å¤–ã®è¦æ±‚ã€‚",
        "è­°ä¼šã¨ã—ã¦ä¸é©åˆ‡ã€‚"
    ],
    "9. ä½æ°‘è¦–ç‚¹ãƒ»èª¬æ˜è²¬ä»»ã®æ˜ç­æ€§": [
        "ä½æ°‘åˆ©ç›ŠãŒæ˜ç¢ºã§ã€å¸‚æ°‘ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚èª¬æ˜è²¬ä»»ãŒæ¥µã‚ã¦é«˜ã„ã€‚",
        "ä½æ°‘ç›®ç·šãŒååˆ†ã€‚",
        "åˆ†ã‹ã‚Šã‚„ã™ãæ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "ä½æ°‘ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚„ã‚„å¼±ã„ã€‚",
        "å°‚é–€çš„ã™ãã‚‹éƒ¨åˆ†ã‚ã‚Šã€‚",
        "ä½æ°‘è¦–ç‚¹ãŒä¸è¶³ã€‚",
        "è¡Œæ”¿å†…éƒ¨å‘ã‘è³ªå•ã«åã‚Šã€‚",
        "å¸‚æ°‘ã«ç†è§£ã•ã‚Œã«ãã„è¡¨ç¾ã€‚",
        "ä½æ°‘åˆ©ç›ŠãŒã»ã¼ç¤ºã•ã‚Œãªã„ã€‚",
        "å¸‚æ°‘ã®åˆ©ç›Šã¨ç„¡é–¢ä¿‚ã€‚"
    ],
    "10. ç­”å¼å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼å¯èƒ½æ€§": [
        "ç­”å¼ã‚’KPIåŒ–ã§ãã€æ”¹å–„çŠ¶æ³ã‚’æ¤œè¨¼ã§ãã‚‹å„ªã‚ŒãŸè¨­è¨ˆã€‚",
        "ãƒ•ã‚©ãƒ­ãƒ¼ã—ã‚„ã™ã„ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒã¨ã—ã¦æ‰±ãˆã‚‹ã€‚",
        "ä¸€å®šã®ãƒ•ã‚©ãƒ­ãƒ¼ã¯å¯èƒ½ã€‚",
        "ãƒ•ã‚©ãƒ­ãƒ¼ã«ã¯å·¥å¤«ãŒå¿…è¦ã€‚",
        "æ”¹å–„çŠ¶æ³ãŒè¿½ã„ã¥ã‚‰ã„ã€‚",
        "ç¶™ç¶šå¯©æŸ»ã«ã¯ä¸å‘ãã€‚",
        "ç­”å¼ãŒæ›–æ˜§ã«çµ‚ã‚ã‚‹å¯èƒ½æ€§é«˜ã„ã€‚",
        "æ”¿ç­–æ¤œè¨¼ãŒã§ããªã„ã€‚",
        "ãƒ•ã‚©ãƒ­ãƒ¼ä¸èƒ½ã€‚"
    ],
    "11. æ–‡ç« è¡¨ç¾ãƒ»ã‚¹ãƒ”ãƒ¼ãƒæŠ€è¡“": [
        "éå¸¸ã«æ˜å¿«ãƒ»ç°¡æ½”ãƒ»ä¸å¯§ã€‚èãæ‰‹ã«ã¨ã£ã¦è² è·ãªã—ã€‚",
        "æ´—ç·´ã•ã‚ŒãŸè¡¨ç¾ã€‚",
        "ååˆ†ã«åˆ†ã‹ã‚Šã‚„ã™ã„ã€‚",
        "æ”¹å–„ä½™åœ°ã‚ã‚Šã€‚",
        "å†—é•·ã¾ãŸã¯ä¸æ˜ç­ç®‡æ‰€ãŒã‚ã‚‹ã€‚",
        "ä¼ã‚ã‚Šã«ãã„éƒ¨åˆ†ãŒå¤šã„ã€‚",
        "èª¤è§£ã‚’æ‹›ãè¡¨ç¾ã‚ã‚Šã€‚",
        "æ–‡ç« æ§‹é€ ãŒç ´ç¶»æ°—å‘³ã€‚",
        "ä¸é©åˆ‡ãªè¨€è‘‰é£ã„ã€‚",
        "è¡¨ç¾ã¨ã—ã¦æˆç«‹ã—ã¦ã„ãªã„ã€‚"
    ],
    "12. è¡Œæ”¿ã¨ã®å”åƒå§¿å‹¢ãƒ»å€«ç†æ€§": [
        "å…¬å¹³ãƒ»ä¸­ç«‹ãƒ»ä½æ°‘åˆ©ç›Šå„ªå…ˆã§æ¥µã‚ã¦è‰¯å¥½ã€‚å€«ç†ã‚‚å®Œç’§ã€‚",
        "é©åˆ‡ãªå§¿å‹¢ã€‚",
        "æ¦‚ã­è‰¯å¥½ã€‚",
        "æ”¹å–„ã®ä½™åœ°ã‚ã‚Šã€‚",
        "è¡Œæ”¿åœ§è¿«ã«è¦‹ãˆã‚‹éƒ¨åˆ†ã‚ã‚Šã€‚",
        "å…¬å¹³æ€§ã«ç–‘ç¾©ã‚ã‚Šã€‚",
        "åˆ©ç›Šèª˜å°ã¨èª¤è§£ã•ã‚Œå¾—ã‚‹ã€‚",
        "è¡Œæ”¿è² æ‹…ã‚’éåº¦ã«å¢—ã‚„ã™ã€‚",
        "å€«ç†ã«åã™ã‚‹æã‚Œã€‚",
        "æ”¿æ²»å€«ç†é•åãƒ¬ãƒ™ãƒ«ã€‚"
    ],
    "13. å°†æ¥å¿—å‘ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ€§": [
        "DX/AIãƒ»æŒç¶šå¯èƒ½æ€§ãªã©æœªæ¥ã‚’è¦‹æ®ãˆãŸé«˜åº¦ãªææ¡ˆã€‚",
        "å°†æ¥è¦–ç‚¹ãŒå¼·ã„ã€‚",
        "æ–°ã—ã„ç™ºæƒ³ãŒã‚ã‚‹ã€‚",
        "ä¸€å®šã®å°†æ¥å¿—å‘ã€‚",
        "ç¾çŠ¶ç¶­æŒå‹ã®è³ªå•ãŒå¤šã„ã€‚",
        "æœªæ¥ã¸ã®è¦–ç‚¹ãŒå¼±ã„ã€‚",
        "çŸ­æœŸçš„è¦–é‡ã«åã‚‹ã€‚",
        "é©æ–°æ€§ãŒã»ã¼ãªã„ã€‚",
        "å¾Œã‚å‘ããªææ¡ˆã€‚",
        "æ™‚ä»£ã«é€†è¡Œã—ã¦ã„ã‚‹ã€‚"
    ],
    "14. æ”¿ç­–æ¨ªæ–­æ€§ãƒ»å…¨ä½“è¦–ç‚¹": [
        "è¤‡æ•°æ–½ç­–ã®é–¢ä¿‚æ€§ã‚’é«˜åº¦ã«æ•´ç†ã—ã€æ¨ªæ–­çš„ã«å•ã„ã‚’æ§‹ç¯‰ã€‚",
        "éƒ¨å±€æ¨ªæ–­ã®è¦–ç‚¹ãŒå¼·ã„ã€‚",
        "åºƒã„è¦–é‡ã§æ•´ç†ã•ã‚Œã¦ã„ã‚‹ã€‚",
        "æ¦‚ã­OKã€‚",
        "ã‚„ã‚„è¦–é‡ãŒé™å®šçš„ã€‚",
        "å˜ä¸€éƒ¨å±€è¦–ç‚¹ã«åã‚‹ã€‚",
        "æ¨ªæ–­çš„ç†è§£ãŒä¸è¶³ã€‚",
        "è¦–é‡ç‹­çª„ã€‚",
        "å…¨ä½“åƒãŒãªã„ã€‚",
        "æ–­ç‰‡çš„ã§ç„¡ç§©åºã€‚"
    ],
    "15. è­°å“¡ã¨ã—ã¦ã®æˆé•·ãƒ»ç¶™ç¶šæ€§": [
        "éå»è³ªå•ã®æ”¹å–„ãŒé¡•è‘—ã§ã€ç¶™ç¶šçš„ã«æ·±ã¾ã‚ŠãŒã‚ã‚‹ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒã®è¿½ç©¶ãŒä¸€è²«ã€‚",
        "æ”¹å–„æ„è­˜ãŒè¦‹ã‚‰ã‚Œã‚‹ã€‚",
        "ç¶™ç¶šãƒ†ãƒ¼ãƒã¸ã®é–¢å¿ƒã‚ã‚Šã€‚",
        "å¤‰åŒ–ãŒã‚„ã‚„å¼±ã„ã€‚",
        "æ¯å›ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å°è±¡ã€‚",
        "æ”¹å–„ãŒè¦‹ãˆãªã„ã€‚",
        "èª²é¡ŒãŒå›ºå®šåŒ–ã—ã¦ã„ã‚‹ã€‚",
        "æˆé•·ãŒä¹ã—ã„ã€‚",
        "æ”¹å–„ãŒã¾ã£ãŸãè¦‹ã‚‰ã‚Œãªã„ã€‚"
    ]
}

# ======================================================
# ãƒ©ãƒ³ã‚¯åˆ¤å®š
# ======================================================
def judge_rank(total: int) -> str:
    if total >= 135:
        return "Sï¼ˆéå¸¸ã«å„ªã‚ŒãŸä¸€èˆ¬è³ªå•ï¼‰"
    if total >= 120:
        return "Aï¼ˆè³ªãŒé«˜ãæ”¿ç­–åŠ¹æœãŒæœŸå¾…ã§ãã‚‹ï¼‰"
    if total >= 105:
        return "Bï¼ˆä¸€å®šæ°´æº–ã ãŒæ”¹å–„ä½™åœ°ã‚ã‚Šï¼‰"
    if total >= 90:
        return "Cï¼ˆåŸºæœ¬çš„æ°´æº–ã€è¦æ”¹å–„ï¼‰"
    if total >= 75:
        return "Dï¼ˆè³ªãŒä½ãã€åŠ¹æœãŒå¼±ã„ï¼‰"
    return "Eï¼ˆè­°ä¼šè³ªå•ã¨ã—ã¦å†æ§‹ç¯‰ãŒå¿…è¦ï¼‰"

# ======================================================
# GPT ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
# ======================================================
def build_eval_prompt(text: str) -> str:
    # è©•ä¾¡é …ç›®åã ã‘ç°¡æ½”ã«æ¸¡ã™
    items = [
        "1. ãƒ†ãƒ¼ãƒè¨­å®šã®å¦¥å½“æ€§",
        "2. ç›®çš„ã®æ˜ç¢ºæ€§",
        "3. è«–ç†æ§‹æˆã®æ˜ç¢ºæ€§",
        "4. æ ¹æ‹ ãƒ»ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã®å¦¥å½“æ€§",
        "5. è³ªå•ã®å…·ä½“æ€§",
        "6. æ”¿ç­–ææ¡ˆã®å®Ÿç¾å¯èƒ½æ€§",
        "7. è¡Œæ”¿ç­”å¼ã‚’å¼•ãå‡ºã™è³ªå•åŠ›",
        "8. è­°ä¼šã®å½¹å‰²ãƒ»æ³•çš„ç†è§£",
        "9. ä½æ°‘è¦–ç‚¹ãƒ»èª¬æ˜è²¬ä»»ã®æ˜ç­æ€§",
        "10. ç­”å¼å¾Œã®ãƒ•ã‚©ãƒ­ãƒ¼å¯èƒ½æ€§",
        "11. æ–‡ç« è¡¨ç¾ãƒ»ã‚¹ãƒ”ãƒ¼ãƒæŠ€è¡“",
        "12. è¡Œæ”¿ã¨ã®å”åƒå§¿å‹¢ãƒ»å€«ç†æ€§",
        "13. å°†æ¥å¿—å‘ãƒ»ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³æ€§",
        "14. æ”¿ç­–æ¨ªæ–­æ€§ãƒ»å…¨ä½“è¦–ç‚¹",
        "15. è­°å“¡ã¨ã—ã¦ã®æˆé•·ãƒ»ç¶™ç¶šæ€§"
    ]
    items_text = "\n".join(items)

    prompt = f"""
ã‚ãªãŸã¯ã€Œåœ°æ–¹è­°ä¼šã®ä¸€èˆ¬è³ªå•ã€ã‚’å°‚é–€ã«è©•ä¾¡ã™ã‚‹ãƒ—ãƒ­ã®è©•ä¾¡è€…ã§ã™ã€‚
æ¬¡ã®ä¸€èˆ¬è³ªå•ã®åŸç¨¿ã‚’ã€ä¸‹è¨˜15é …ç›®ã«ã¤ã„ã¦1ã€œ10ç‚¹ã§æ¡ç‚¹ã—ã¦ãã ã•ã„ã€‚

ã€è©•ä¾¡é …ç›®ã€‘
{items_text}

ã€æ¡ç‚¹ãƒ«ãƒ¼ãƒ«ã€‘
- å„é …ç›® 1ã€œ10ç‚¹ï¼ˆæ•´æ•°ã®ã¿ï¼‰
- 10ç‚¹ãŒæœ€ã‚‚å„ªã‚Œã¦ã„ã‚‹
- 15é …ç›®ã®åˆè¨ˆç‚¹ã¯æœ€å¤§150ç‚¹
- è©•ä¾¡ã¯ã€ä¸ãˆã‚‰ã‚ŒãŸæ–‡ç« ã®å†…å®¹ã®ã¿ã‹ã‚‰è¡Œã†

ã€è©•ä¾¡å¯¾è±¡ã®ä¸€èˆ¬è³ªå•ã€‘
{text}

ã€å‡ºåŠ›å½¢å¼ï¼ˆå³å®ˆï¼‰ã€‘
æ¬¡ã® JSON å½¢å¼ã€Œã ã‘ã€ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªã®ã‚³ãƒ¡ãƒ³ãƒˆã‚„èª¬æ˜æ–‡ã¯æ›¸ã‹ãªã„ã§ãã ã•ã„ã€‚

{{
  "scores": {{
    "1": 1ã€œ10ã®æ•´æ•°,
    "2": 1ã€œ10ã®æ•´æ•°,
    ...
    "15": 1ã€œ10ã®æ•´æ•°
  }},
  "total": åˆè¨ˆç‚¹ï¼ˆæ•´æ•°ï¼‰,
  "rank": "S" ã¾ãŸã¯ "A" ã¾ãŸã¯ "B" ã¾ãŸã¯ "C" ã¾ãŸã¯ "D" ã¾ãŸã¯ "E",
  "reasons": {{
    "1": "1ã®é …ç›®ã®ç‚¹æ•°ã¨ã—ãŸç†ç”±ï¼ˆæ—¥æœ¬èªã€2ã€œ3æ–‡ç¨‹åº¦ï¼‰",
    "2": "2ã®é …ç›®ã®ç†ç”±",
    ...
    "15": "15ã®é …ç›®ã®ç†ç”±"
  }}
}}

â€» å¿…ãš JSON ã®ã¿ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
"""
    return prompt.strip()

# ======================================================
# UIï¼šã‚¿ãƒ–æ§‹æˆ
# ======================================================
tab_ai, tab_manual = st.tabs(["ğŸ¤– AIè‡ªå‹•æ¡ç‚¹", "ğŸ“ æ‰‹å‹•æ¡ç‚¹"])

# ======================================================
# ã‚¿ãƒ–1ï¼šAI è‡ªå‹•æ¡ç‚¹
# ======================================================
with tab_ai:
    st.header("ğŸ¤– AI è‡ªå‹•æ¡ç‚¹ï¼ˆGPT-4.1 ä½¿ç”¨ï¼‰")

    question_text = st.text_area(
        "è©•ä¾¡ã—ãŸã„ä¸€èˆ¬è³ªå•ã®åŸç¨¿ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„",
        height=280
    )

    if st.button("ğŸš€ AIã§è‡ªå‹•æ¡ç‚¹ã™ã‚‹"):
        if not api_key:
            st.error("APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆå·¦ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼‰ã€‚")
        elif not question_text.strip():
            st.error("ä¸€èˆ¬è³ªå•ã®æ–‡ç« ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        elif client is None:
            st.error("OpenAI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¦ã„ã¾ã™ã€‚APIã‚­ãƒ¼ã‚’ã”ç¢ºèªãã ã•ã„ã€‚")
        else:
            with st.spinner("AIãŒæ¡ç‚¹ã—ã¦ã„ã¾ã™â€¦"):
                try:
                    prompt = build_eval_prompt(question_text)

                    response = client.chat.completions.create(
                        model="gpt-4.1",
                        messages=[{"role": "user", "content": prompt}]
                    )

                    raw = response.choices[0].message.content.strip()

                    # ä¸‡ä¸€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã§è¿”ã£ã¦ããŸå ´åˆã«å‚™ãˆã¦ {} ã§ãƒˆãƒªãƒŸãƒ³ã‚°
                    start = raw.find("{")
                    end = raw.rfind("}")
                    if start != -1 and end != -1:
                        raw_json = raw[start:end+1]
                    else:
                        raw_json = raw

                    data = json.loads(raw_json)

                except Exception as e:
                    st.error("AIã‹ã‚‰ã®å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ä¸‹ã«è¡¨ç¤ºã—ã¾ã™ã€‚")
                    st.code(raw if 'raw' in locals() else str(e))
                else:
                    scores = data.get("scores", {})
                    total = data.get(
                        "total",
                        sum(int(v) for v in scores.values() if str(v).isdigit())
                    )
                    rank = data.get("rank", judge_rank(total))
                    reasons = data.get("reasons", {})

                    st.success("æ¡ç‚¹ãŒå®Œäº†ã—ã¾ã—ãŸã€‚")

                    st.subheader("ğŸ“Š å„é …ç›®ã®è©•ä¾¡")

                    titles = list(criteria.keys())
                    for i in range(1, 16):
                        key = str(i)
                        title = titles[i-1]
                        score_val = scores.get(key, "-")
                        reason_text = reasons.get(key, "ï¼ˆç†ç”±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰")

                        with st.expander(f"{i}. {title}ï¼š{score_val}ç‚¹", expanded=False):
                            st.write(reason_text)

                    st.markdown("---")
                    st.markdown(f"## ğŸ”¢ åˆè¨ˆç‚¹ï¼š**{total} / 150 ç‚¹**")
                    st.markdown(f"## ğŸ† ãƒ©ãƒ³ã‚¯ï¼š**{judge_rank(total)}**")

# ======================================================
# ã‚¿ãƒ–2ï¼šæ‰‹å‹•æ¡ç‚¹
# ======================================================
with tab_manual:
    st.header("ğŸ“ 150ç‚¹ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹æ‰‹å‹•æ¡ç‚¹")

    total_manual = 0
    titles = list(criteria.keys())

    for idx, (title, desc_list) in enumerate(criteria.items(), start=1):
        with st.expander(f"{idx}. {title}", expanded=False):
            score = st.slider(
                "ç‚¹æ•°ã‚’é¸æŠï¼ˆ1ã€œ10ï¼‰",
                min_value=1,
                max_value=10,
                value=7,
                key=f"manual_score_{idx}"   # â˜… ã“ã“ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ãª key ã‚’ä»˜ä¸
            )
            # 10ç‚¹â†’index0, 9ç‚¹â†’1 â€¦ 1ç‚¹â†’9
            explanation = desc_list[10 - score]
            st.caption(f"ğŸ“Œ ã“ã®ç‚¹æ•°æ°´æº–ã®ç›®å®‰ï¼š{explanation}")
            total_manual += score

    st.markdown("---")
    st.subheader(f"ğŸ”¢ åˆè¨ˆç‚¹ï¼š**{total_manual} / 150 ç‚¹**")
    st.subheader(f"ğŸ† ãƒ©ãƒ³ã‚¯ï¼š**{judge_rank(total_manual)}**")
